<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор времени</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Верхний блок с белым фоном -->
    <div class="top-bar">
        <button class="back-button">Назад</button>
        <h1>Выбор времени</h1>
    </div>

    <!-- Основной контент на сером фоне -->
    <div class="content">
        <!-- Выбор дня -->
        <div class="date-selection">
            <h2>Выберите день</h2>
            <div class="month-navigation">
                <button class="nav-button" id="prev-month"><</button>
                <span id="current-month">Март 2025</span>
                <button class="nav-button" id="next-month">></button>
            </div>
            <div class="calendar" id="calendar">
                <div class="calendar-header">
                    <div>ПН</div>
                    <div>ВТ</div>
                    <div>СР</div>
                    <div>ЧТ</div>
                    <div>ПТ</div>
                    <div>СБ</div>
                    <div>ВС</div>
                </div>
                <div class="calendar-body" id="calendar-body">
                    <!-- Календарь будет заполнен через JavaScript -->
                </div>
            </div>
        </div>

        <!-- Выбор времени -->
        <div class="time-selection">
            <h2>Выберите время</h2>
            <div class="time-slots" id="time-slots">
                <!-- Время будет заполнено через JavaScript -->
            </div>
        </div>

        <!-- Контейнер для кнопки "Записаться" -->
        <div id="confirm-button-container">
            <button class="confirm-button" disabled>Записаться</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedMasterId = urlParams.get('selected_master_id');
            const serviceId = urlParams.get('service_id');
            const fio = urlParams.get('fio');
            const phone = urlParams.get('phone');
            const originalMasterId = urlParams.get('original_master_id');

            // Проверка наличия всех параметров
            if (!selectedMasterId || !serviceId || !fio || !phone || !originalMasterId) {
                alert("Ошибка: не все данные переданы.");
                window.history.back();
                return;
            }

            let currentDate = new Date(2025, 2, 1); // Март 2025
            let selectedDay = null;
            let selectedTime = null;

            const calendarBody = document.getElementById('calendar-body');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const timeSlotsContainer = document.getElementById('time-slots');
            const confirmButtonContainer = document.getElementById('confirm-button-container');
            const backButton = document.querySelector('.back-button');

            // Функция возврата на appointment.html с сохранением всех параметров
            function goBack() {
                const redirectUrl = `appointment.html?master_id=${originalMasterId}&selected_master_id=${selectedMasterId}&service_id=${serviceId}&fio=${fio}&phone=${phone}`;
                window.location.href = redirectUrl;
            }

            // Привязка обработчика к кнопке "Назад"
            backButton.addEventListener('click', goBack);

            // Генерация временных слотов (9:00–18:00, шаг 15 минут)
            function generateTimeSlots() {
                timeSlotsContainer.innerHTML = '';
                for (let hour = 9; hour <= 18; hour++) {
                    for (let minute = 0; minute < 60; minute += 15) {
                        if (hour === 18 && minute > 0) break;
                        const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        const timeSlot = document.createElement('div');
                        timeSlot.classList.add('time-slot');
                        timeSlot.textContent = time;
                        timeSlot.addEventListener('click', () => {
                            if (selectedTime) selectedTime.classList.remove('selected');
                            selectedTime = timeSlot;
                            timeSlot.classList.add('selected');
                            updateConfirmButtonState();
                        });
                        timeSlotsContainer.appendChild(timeSlot);
                    }
                }
            }

            // Отрисовка календаря
            function renderCalendar() {
                calendarBody.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                currentMonthElement.textContent = new Intl.DateTimeFormat('ru-RU', {
                    year: 'numeric',
                    month: 'long'
                }).format(currentDate);

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

                let date = 1;
                for (let i = 0; i < 6; i++) {
                    for (let j = 0; j < 7; j++) {
                        const day = document.createElement('div');
                        if (i === 0 && j < startDay || date > lastDay.getDate()) {
                            day.classList.add('calendar-day', 'empty');
                        } else {
                            day.classList.add('calendar-day');
                            day.textContent = date;
                            day.addEventListener('click', () => {
                                if (selectedDay) selectedDay.classList.remove('selected');
                                selectedDay = day;
                                day.classList.add('selected');
                                updateConfirmButtonState();
                            });
                            date++;
                        }
                        calendarBody.appendChild(day);
                    }
                }
            }

            // Обновление состояния кнопки "Записаться"
            function updateConfirmButtonState() {
                const button = confirmButtonContainer.querySelector('.confirm-button');
                if (selectedDay && selectedTime) {
                    const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(selectedDay.textContent));
                    selectedDate.setHours(12); // Устанавливаем время для корректной даты
                    const formattedDate = selectedDate.toISOString().split('T')[0];
                    const formattedTime = selectedTime.textContent;

                    button.disabled = false;
                    button.removeEventListener('click', handleConfirm);
                    button.addEventListener('click', handleConfirm);

                    function handleConfirm() {
                        confirmAppointment(formattedDate, formattedTime);
                    }
                } else {
                    button.disabled = true;
                    button.removeEventListener('click', handleConfirm);
                }
            }

            // Создание записи и перенаправление
            function confirmAppointment(date, time) {
                fetch('create_appointment.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        master_id: selectedMasterId,
                        service_id: serviceId,
                        fio: decodeURIComponent(fio), // Декодируем ФИО
                        phone: phone,
                        date: date,
                        time: time
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Запись успешно создана!');
                        window.location.href = `masterReq.html?master_id=${originalMasterId}`;
                    } else {
                        alert('Ошибка при создании записи: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка при создании записи:', error);
                    alert('Произошла ошибка при отправке данных.');
                });
            }

            // Переключение месяцев
            prevMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Инициализация
            generateTimeSlots();
            renderCalendar();
        });
    </script>
</body>
</html>