<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор времени</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="top-bar">
        <button class="back-button">Назад</button>
        <h1>Выбор времени</h1>
    </div>

    <div class="content">
        <div class="date-selection">
            <h2>Выберите день</h2>
            <div class="month-navigation">
                <button class="nav-button" id="prev-month"><</button>
                <span id="current-month"></span>
                <button class="nav-button" id="next-month">></button>
            </div>
            <div class="calendar" id="calendar">
                <div class="calendar-header">
                    <div>ПН</div>
                    <div>ВТ</div>
                    <div>СР</div>
                    <div>ЧТ</div>
                    <div>ПТ</div>
                    <div>СБ</div>
                    <div>ВС</div>
                </div>
                <div class="calendar-body" id="calendar-body">
                    <!-- Календарь будет заполнен через JavaScript -->
                </div>
            </div>
        </div>

        <div class="time-selection">
            <h2>Выберите время</h2>
            <div class="time-slots" id="time-slots">
                <!-- Время будет заполнено через JavaScript -->
            </div>
        </div>

        <div id="confirm-button-container">
            <button class="confirm-button" disabled>Записаться</button>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Извлечение параметров из URL
    const urlParams = new URLSearchParams(window.location.search);
    const selectedMasterId = urlParams.get('selected_master_id');
    const serviceId = urlParams.get('service_id');
    const fio = urlParams.get('fio');
    const phone = urlParams.get('phone');
    const originalMasterId = urlParams.get('original_master_id');
    const clientId = urlParams.get('client_id');
    const role = urlParams.get('role');
    const appointmentId = urlParams.get('appointment_id') || ''; // Добавлен параметр appointment_id
    const action = urlParams.get('action') || 'create'; // Добавлен параметр action (create или update)

    // Проверка наличия всех обязательных параметров
    if (!selectedMasterId || !serviceId || !fio || !phone || !originalMasterId || !role) {
        alert('Ошибка: не все данные переданы. Пожалуйста, вернитесь и попробуйте снова.');
        window.history.back();
        return;
    }

    // Константы и начальные значения
    const DAYS_OF_WEEK = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'];
    const now = new Date();
    const permTime = new Date(now.getTime() + (5 * 60 * 60 * 1000)); // Пермское время (UTC+5)
    const minDate = new Date(permTime.getFullYear(), permTime.getMonth(), 1); // Начало текущего месяца
    let currentDate = new Date(minDate); // Текущий отображаемый месяц
    let selectedDay = null;
    let selectedTime = null;

    // Элементы DOM
    const calendarBody = document.getElementById('calendar-body');
    const currentMonthElement = document.getElementById('current-month');
    const prevMonthButton = document.getElementById('prev-month');
    const nextMonthButton = document.getElementById('next-month');
    const timeSlotsContainer = document.getElementById('time-slots');
    const confirmButtonContainer = document.getElementById('confirm-button-container');
    const backButton = document.querySelector('.back-button');

    // Функция возврата на предыдущую страницу с сохранением параметров
    const goBack = () => {
        const redirectUrl = `appointment.html?master_id=${originalMasterId}&selected_master_id=${selectedMasterId}&service_id=${serviceId}&fio=${fio}&phone=${phone}&role=${role}&appointment_id=${appointmentId}&action=${action}`;
        window.location.href = redirectUrl;
    };
    backButton.addEventListener('click', goBack);

    // Рендеринг календаря
    const renderCalendar = () => {
        calendarBody.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        currentMonthElement.textContent = new Intl.DateTimeFormat('ru-RU', {
            year: 'numeric',
            month: 'long'
        }).format(currentDate);

        prevMonthButton.disabled = (year === minDate.getFullYear() && month === minDate.getMonth());

        const firstDay = new Date(year, month, 1);
        const startDay = (firstDay.getDay() + 6) % 7; // ПН=0, ВС=6
        const totalDays = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarBody.appendChild(emptyDay);
        }

        for (let date = 1; date <= totalDays; date++) {
            const day = document.createElement('div');
            day.classList.add('calendar-day');
            day.textContent = date;

            const currentDay = new Date(Date.UTC(year, month, date));
            const isPast = currentDay < permTime.setHours(0, 0, 0, 0);

            if (isPast && year === permTime.getFullYear() && month === permTime.getMonth()) {
                day.classList.add('disabled');
            } else {
                day.addEventListener('click', () => {
                    if (selectedDay) selectedDay.classList.remove('selected');
                    selectedDay = day;
                    day.classList.add('selected');
                    const selectedDate = new Date(Date.UTC(year, month, date));
                    fetchAvailableSlots(selectedDate);
                    updateConfirmButtonState();
                });
            }
            calendarBody.appendChild(day);
        }

        const totalCells = startDay + totalDays;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < remainingCells; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarBody.appendChild(emptyDay);
        }
    };

    // Получение доступных временных слотов
    const fetchAvailableSlots = (date) => {
        const formattedDate = date.toISOString().split('T')[0];
        fetch(`get_available_slots.php?master_id=${selectedMasterId}&service_id=${serviceId}&date=${formattedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.available_slots) {
                    populateTimeSlots(data.available_slots);
                } else {
                    console.error('Ошибка от сервера:', data.error);
                    populateTimeSlots([]);
                }
            })
            .catch(error => {
                console.error('Ошибка при получении слотов:', error);
                populateTimeSlots([]);
            });
    };

    // Заполнение слотов времени
    const populateTimeSlots = (slots) => {
        timeSlotsContainer.innerHTML = '';
        if (slots.length === 0) {
            timeSlotsContainer.innerHTML = '<p>Нет доступных временных слотов</p>';
            selectedTime = null;
            updateConfirmButtonState();
            return;
        }

        slots.forEach(time => {
            const timeSlot = document.createElement('div');
            timeSlot.classList.add('time-slot');
            timeSlot.textContent = time;
            timeSlot.addEventListener('click', () => {
                if (selectedTime) selectedTime.classList.remove('selected');
                selectedTime = timeSlot;
                timeSlot.classList.add('selected');
                updateConfirmButtonState();
            });
            timeSlotsContainer.appendChild(timeSlot);
        });
    };

    // Обновление состояния кнопки "Записаться"
    const updateConfirmButtonState = () => {
        const button = confirmButtonContainer.querySelector('.confirm-button');
        button.disabled = !(selectedDay && selectedTime);
    };

    // Создание или обновление записи
    const confirmAppointment = (date, time) => {
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        const formattedTime = time;

        // Выбор URL в зависимости от действия
        const url = action === 'update' && appointmentId ? 'update_appointment.php' : 'create_appointment.php';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                appointment_id: appointmentId || '', // Передача appointment_id
                master_id: selectedMasterId,
                service_id: serviceId,
                fio: decodeURIComponent(fio),
                phone: decodeURIComponent(phone),
                date: formattedDate,
                time: formattedTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(action === 'update' ? 'Запись успешно обновлена!' : 'Запись успешно создана!');
                if (role === 'master') {
                    window.location.href = `masterReq.html?master_id=${originalMasterId}`;
                } else if (role === 'client') {
                    window.location.href = `clientReq.html?client_id=${clientId}`;
                }
            } else {
                alert(`Ошибка: ${data.message || 'Неизвестная ошибка'}`);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при отправке данных. Пожалуйста, попробуйте снова.');
        });
    };

    // Обработчик кнопки "Записаться"
    const confirmButton = confirmButtonContainer.querySelector('.confirm-button');
    confirmButton.addEventListener('click', () => {
        if (selectedDay && selectedTime) {
            const selectedDate = new Date(Date.UTC(
                currentDate.getFullYear(),
                currentDate.getMonth(),
                parseInt(selectedDay.textContent)
            ));
            const formattedTime = selectedTime.textContent;
            confirmAppointment(selectedDate, formattedTime);
        }
    });

    // Переключение месяцев
    prevMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // Инициализация
    renderCalendar();
});
    </script>
</body>
</html>