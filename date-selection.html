<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор времени</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Верхний блок с белым фоном -->
    <div class="top-bar">
        <button class="back-button" onclick="goBack()">Назад</button>
        <h1>Выбор времени</h1>
    </div>

    <!-- Основной контент на сером фоне -->
    <div class="content">
        <!-- Выбор дня -->
        <div class="date-selection">
            <h2>Выберите день</h2>
            <div class="month-navigation">
                <button class="nav-button" id="prev-month">&lt;</button>
                <span id="current-month">Март 2025</span>
                <button class="nav-button" id="next-month">&gt;</button>
            </div>
            <div class="calendar" id="calendar">
                <div class="calendar-header">
                    <div>ПН</div>
                    <div>ВТ</div>
                    <div>СР</div>
                    <div>ЧТ</div>
                    <div>ПТ</div>
                    <div>СБ</div>
                    <div>ВС</div>
                </div>
                <div class="calendar-body" id="calendar-body">
                    <!-- Календарь будет заполнен через JavaScript -->
                </div>
            </div>
        </div>

        <!-- Выбор времени -->
        <div class="time-selection">
            <h2>Выберите время</h2>
            <div class="time-slots" id="time-slots">
                <!-- Время будет заполнено через JavaScript -->
            </div>
        </div>

        <!-- Контейнер для кнопки "Записаться" -->
        <div id="confirm-button-container">
            <button class="confirm-button" id="confirm-button" disabled>Записаться</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const masterId = urlParams.get('master_id');
        const previousPage = urlParams.get('previousPage');

        function goBack() {
            if (previousPage) {
                window.location.href = `${previousPage}?master_id=${masterId}`;
            } else {
                window.history.back(); // На случай, если previousPage не передан
            }
        }

        document.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('confirm-button')) {
                const selectedDay = document.querySelector('.calendar-day.selected');
                const selectedTime = document.querySelector('.time-slot.selected');

                if (!selectedDay || !selectedTime) {
                    alert("Выберите дату и время.");
                    return;
                }

                const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(selectedDay.textContent, 10));
                selectedDate.setHours(12); // Устанавливаем время на 12:00, чтобы избежать ошибок с часовыми поясами
                confirmAppointment(selectedDate.toISOString().split('T')[0], selectedTime.textContent);
            }
        });

        let currentDate = new Date(2025, 2, 1); // Март 2025
        let selectedDay = null;
        let selectedTime = null;

        const calendarBody = document.getElementById('calendar-body');
        const currentMonthElement = document.getElementById('current-month');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const timeSlotsContainer = document.getElementById('time-slots');
        const confirmButtonContainer = document.getElementById('confirm-button-container');

        // Функция для генерации слотов времени с 9:00 до 18:00 с интервалом 15 минут
        function generateTimeSlots() {
            timeSlotsContainer.innerHTML = '';
            for (let hour = 9; hour <= 18; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    if (hour === 18 && minute > 0) break; // Останавливаемся на 18:00
                    const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    const timeSlot = document.createElement('div');
                    timeSlot.classList.add('time-slot');
                    timeSlot.textContent = time;
                    timeSlot.addEventListener('click', () => {
                        if (selectedTime) selectedTime.classList.remove('selected');
                        selectedTime = timeSlot;
                        timeSlot.classList.add('selected');
                        updateConfirmButtonState();
                    });
                    timeSlotsContainer.appendChild(timeSlot);
                }
            }
        }

        // Функция для отрисовки календаря
        function renderCalendar() {
            calendarBody.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthElement.textContent = new Intl.DateTimeFormat('ru-RU', {
                year: 'numeric',
                month: 'long'
            }).format(currentDate);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Понедельник как первый день недели

            let date = 1;
            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 7; j++) {
                    const day = document.createElement('div');
                    if (i === 0 && j < startDay) {
                        day.classList.add('calendar-day', 'empty');
                    } else if (date > lastDay.getDate()) {
                        day.classList.add('calendar-day', 'empty');
                    } else {
                        day.classList.add('calendar-day');
                        day.textContent = date;
                        day.addEventListener('click', () => {
                            if (selectedDay) selectedDay.classList.remove('selected');
                            selectedDay = day;
                            day.classList.add('selected');
                            updateConfirmButtonState();
                        });
                        date++;
                    }
                    calendarBody.appendChild(day);
                }
            }
        }

        // Функция для обновления состояния кнопки "Записаться"
        function updateConfirmButtonState() {
            if (selectedDay && selectedTime) {
                const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDay.textContent);
                selectedDate.setHours(12); // Устанавливаем время на 12:00
                const formattedDate = selectedDate.toISOString().split('T')[0]; // Преобразуем дату в формат YYYY-MM-DD
                const formattedTime = selectedTime.textContent; // Читаем выбранное время

                confirmButtonContainer.innerHTML = `
                    <button class="confirm-button" onclick="confirmAppointment('${formattedDate}', '${formattedTime}')">Записаться</button>
                `;
            } else {
                confirmButtonContainer.innerHTML = `
                    <button class="confirm-button" disabled>Записаться</button>
                `;
            }
        }

        // Функция для перехода с передачей данных
        function confirmAppointment(date, time) {
            const urlParams = new URLSearchParams(window.location.search);
            const masterId = urlParams.get('master_id');
            const redirectUrl = `appointment.html?master_id=${masterId}&date=${date}&time=${time}`;
            window.location.href = redirectUrl;
        }

        // Переключение месяцев
        prevMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Инициализация
        generateTimeSlots();
        renderCalendar();
    </script>
</body>
</html>
