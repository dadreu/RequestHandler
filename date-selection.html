<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор времени</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="top-bar">
        <button class="back-button">Назад</button>
        <h1>Выбор времени</h1>
    </div>

    <div class="content">
        <div class="date-selection">
            <h2>Выберите день</h2>
            <div class="month-navigation">
                <button class="nav-button" id="prev-month"><</button>
                <span id="current-month">Март 2025</span>
                <button class="nav-button" id="next-month">></button>
            </div>
            <div class="calendar" id="calendar">
                <div class="calendar-header">
                    <div>ПН</div>
                    <div>ВТ</div>
                    <div>СР</div>
                    <div>ЧТ</div>
                    <div>ПТ</div>
                    <div>СБ</div>
                    <div>ВС</div>
                </div>
                <div class="calendar-body" id="calendar-body">
                    <!-- Календарь будет заполнен через JavaScript -->
                </div>
            </div>
        </div>

        <div class="time-selection">
            <h2>Выберите время</h2>
            <div class="time-slots" id="time-slots">
                <!-- Время будет заполнено через JavaScript -->
            </div>
        </div>

        <div id="confirm-button-container">
            <button class="confirm-button" disabled>Записаться</button>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const selectedMasterId = urlParams.get('selected_master_id');
    const serviceId = urlParams.get('service_id');
    const fio = urlParams.get('fio');
    const phone = urlParams.get('phone');
    const originalMasterId = urlParams.get('original_master_id');
    const daysOfWeek = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС']; // ПН=0, ВС=6

    if (!selectedMasterId || !serviceId || !fio || !phone || !originalMasterId) {
        alert("Ошибка: не все данные переданы.");
        window.history.back();
        return;
    }

    let currentDate = new Date(2025, 2, 1); // Март 2025
    let selectedDay = null;
    let selectedTime = null;

    const calendarBody = document.getElementById('calendar-body');
    const currentMonthElement = document.getElementById('current-month');
    const prevMonthButton = document.getElementById('prev-month');
    const nextMonthButton = document.getElementById('next-month');
    const timeSlotsContainer = document.getElementById('time-slots');
    const confirmButtonContainer = document.getElementById('confirm-button-container');
    const backButton = document.querySelector('.back-button');

    function goBack() {
        const redirectUrl = `appointment.html?master_id=${originalMasterId}&selected_master_id=${selectedMasterId}&service_id=${serviceId}&fio=${fio}&phone=${phone}`;
        window.location.href = redirectUrl;
    }
    backButton.addEventListener('click', goBack);

    function renderCalendar() {
        calendarBody.innerHTML = ''; // Очищаем содержимое

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        currentMonthElement.textContent = new Intl.DateTimeFormat('ru-RU', {
            year: 'numeric',
            month: 'long'
        }).format(currentDate);

        const firstDay = new Date(year, month, 1);
        const startDay = (firstDay.getDay() + 6) % 7; // Сдвиг: ПН=0, ВС=6
        const totalDays = new Date(year, month + 1, 0).getDate();

        // 1. Добавляем пустые ячейки в начале месяца
        for (let i = 0; i < startDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarBody.appendChild(emptyDay);
        }

        // 2. Добавляем дни месяца
        for (let date = 1; date <= totalDays; date++) {
            const day = document.createElement('div');
            day.classList.add('calendar-day');
            day.textContent = date;

            day.addEventListener('click', () => {
                if (selectedDay) selectedDay.classList.remove('selected');
                selectedDay = day;
                day.classList.add('selected');

                const selectedDate = new Date(year, month, date);
                const dayIndex = (selectedDate.getDay() + 6) % 7; // Сдвиг для ПН=0
                console.log('Выбранная дата:', selectedDate.toISOString().split('T')[0]);
                console.log('getDay:', selectedDate.getDay());
                console.log('День недели:', daysOfWeek[dayIndex]);
                fetchAvailableSlots(selectedDate);
                updateConfirmButtonState();
            });

            calendarBody.appendChild(day);
        }

        // 3. Добавляем пустые ячейки в конце
        const totalCells = startDay + totalDays;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < remainingCells; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarBody.appendChild(emptyDay);
        }
    }

    function fetchAvailableSlots(date) {
        const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        fetch(`get_available_slots.php?master_id=${selectedMasterId}&service_id=${serviceId}&date=${formattedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.available_slots) {
                    console.log(`Доступные слоты для ${formattedDate}:`, data.available_slots);
                    populateTimeSlots(data.available_slots);
                } else {
                    console.error('Ошибка от сервера:', data.error);
                    populateTimeSlots([]);
                }
            })
            .catch(error => {
                console.error('Ошибка при получении слотов:', error);
                populateTimeSlots([]);
            });
    }

    function populateTimeSlots(slots) {
        timeSlotsContainer.innerHTML = '';
        if (slots.length === 0) {
            timeSlotsContainer.innerHTML = '<p>Нет доступных временных слотов</p>';
            selectedTime = null;
            updateConfirmButtonState();
            return;
        }
        slots.forEach(time => {
            const timeSlot = document.createElement('div');
            timeSlot.classList.add('time-slot');
            timeSlot.textContent = time;
            timeSlot.addEventListener('click', () => {
                if (selectedTime) selectedTime.classList.remove('selected');
                selectedTime = timeSlot;
                timeSlot.classList.add('selected');
                updateConfirmButtonState();
            });
            timeSlotsContainer.appendChild(timeSlot);
        });
    }

    function updateConfirmButtonState() {
        const button = confirmButtonContainer.querySelector('.confirm-button');
        button.disabled = !(selectedDay && selectedTime);
    }

    function confirmAppointment(date, time) {
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const day = String(localDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        const formattedTime = time;

        console.log('Отправляемая дата:', formattedDate);

        fetch('create_appointment.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                master_id: selectedMasterId,
                service_id: serviceId,
                fio: decodeURIComponent(fio),
                phone: phone,
                date: formattedDate,
                time: formattedTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Запись успешно создана!');
                window.location.href = `masterReq.html?master_id=${originalMasterId}`;
            } else {
                alert('Ошибка при создании записи: ' + (data.message || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка при создании записи:', error);
            alert('Произошла ошибка при отправке данных.');
        });
    }

    const confirmButton = confirmButtonContainer.querySelector('.confirm-button');
    confirmButton.addEventListener('click', () => {
        if (selectedDay && selectedTime) {
            const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(selectedDay.textContent));
            const formattedTime = selectedTime.textContent;
            confirmAppointment(selectedDate, formattedTime);
        }
    });

    prevMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
    </script>
</body>
</html>