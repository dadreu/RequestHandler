<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="content">
        <p>Проверка авторизации...</p>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (!user) {
                alert("Ошибка: данные пользователя не получены.");
                window.history.back();
                return;
            }

            fetch('check_telegram_user.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    telegram_id: user.id,
                    initData: window.Telegram.WebApp.initData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.role === 'master') {
                        window.location.href = `masterReq.html?master_id=${data.master_id}`;
                    } else if (data.role === 'client') {
                        window.location.href = `clientReq.html?client_id=${data.client_id}`;
                    }
                } else {
                    window.location.href = `register.html?telegram_id=${user.id}`;
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка сервера. Попробуйте снова.');
            });
        });
    </script>
</body>
</html>