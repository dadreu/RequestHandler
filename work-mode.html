<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Режим работы</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="top-bar">
        <button class="back-button" onclick="goBack()">Назад</button>
        <h1>Режим работы</h1>
    </div>

    <div class="content">
        <p class="change-time">Настройте время работы</p>

        <div class="work-schedule" id="schedule">
            <!-- Дни недели добавятся через JS -->
        </div>

        <button class="save-btn" onclick="saveSchedule()">Сохранить</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const masterId = urlParams.get("master_id");

            if (masterId) {
                loadSchedule(masterId);
            } else {
                alert("Не указан master_id.");
            }

            populateSchedule();
        });

        function goBack() {
            window.history.back();
        }

        function populateSchedule() {
            const days = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
            const scheduleContainer = document.getElementById("schedule");

            days.forEach((day, index) => {
                const dayId = `day-${index}`;
                scheduleContainer.innerHTML += `
                    <div class="day">
                        <label>${day}</label>
                        <div class="time-column">
                            <div class="time">
                                <select id="${dayId}-start" class="hour"></select> :
                                <select id="${dayId}-start-minutes" class="minute"></select>
                            </div>
                            <div class="time">
                                <select id="${dayId}-end" class="hour"></select> :
                                <select id="${dayId}-end-minutes" class="minute"></select>
                            </div>
                        </div>
                    </div>
                `;
            });

            populateTimeSelectors();
        }

        function populateTimeSelectors() {
            const hours = document.querySelectorAll('.hour');
            const minutes = document.querySelectorAll('.minute');

            for (let h = 9; h <= 20; h++) {
                hours.forEach(hourSelect => {
                    let option = document.createElement('option');
                    option.value = h;
                    option.textContent = h < 10 ? '0' + h : h;
                    hourSelect.appendChild(option);
                });
            }

            [0, 15, 30, 45].forEach(m => {
                minutes.forEach(minSelect => {
                    let option = document.createElement('option');
                    option.value = m;
                    option.textContent = m === 0 ? '00' : m;
                    minSelect.appendChild(option);
                });
            });
        }

        function loadSchedule(masterId) {
            fetch(`load_schedule.php?master_id=${masterId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.schedule) {
                        data.schedule.forEach(item => {
                            const dayIndex = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"].indexOf(item.day_of_week);
                            if (dayIndex !== -1) {
                                document.getElementById(`day-${dayIndex}-start`).value = parseInt(item.start_time.split(':')[0]);
                                document.getElementById(`day-${dayIndex}-start-minutes`).value = parseInt(item.start_time.split(':')[1]);
                                document.getElementById(`day-${dayIndex}-end`).value = parseInt(item.end_time.split(':')[0]);
                                document.getElementById(`day-${dayIndex}-end-minutes`).value = parseInt(item.end_time.split(':')[1]);
                            }
                        });
                    }
                })
                .catch(error => console.error('Ошибка загрузки данных:', error));
        }

        function saveSchedule() {
            const urlParams = new URLSearchParams(window.location.search);
            const masterId = urlParams.get("master_id");

            if (!masterId) {
                alert("Не указан ID мастера.");
                return;
            }

            let scheduleData = [];
            const days = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];

            days.forEach((day, index) => {
                const startHour = document.getElementById(`day-${index}-start`).value.padStart(2, '0');
                const startMinute = document.getElementById(`day-${index}-start-minutes`).value.padStart(2, '0');
                const endHour = document.getElementById(`day-${index}-end`).value.padStart(2, '0');
                const endMinute = document.getElementById(`day-${index}-end-minutes`).value.padStart(2, '0');
                const startTime = `${startHour}:${startMinute}:00`;
                const endTime = `${endHour}:${endMinute}:00`;
                scheduleData.push({
                    day_of_week: day,
                    start_time: startTime,
                    end_time: endTime
                });
            });

            fetch("save_schedule.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ master_id: masterId, schedule: scheduleData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Расписание сохранено!");
                } else {
                    alert("Ошибка сохранения расписания: " + (data.error || "Неизвестная ошибка"));
                }
            })
            .catch(error => console.error("Ошибка сохранения:", error));
        }
    </script>
</body>
</html>