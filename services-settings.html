<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка услуг</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <header class="top-bar">
        <button class="back-button" onclick="window.location.href='masterReq.html?master_id=' + masterId">Назад</button>
        <h1>Настройка услуг</h1>
        <div></div>
    </header>
    <div class="content">
        <p class="select-services">Выберите услуги</p>
        <div id="service-group" class="service-group"></div>
        <div class="buttons-container">
            <button class="save-button" onclick="saveChanges()">Сохранить</button>
            <button class="add-service-button" onclick="goToAddService()">Добавить услугу</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const masterId = urlParams.get('master_id');
        let servicesAvailability = {};

        if (masterId) {
            loadServices(masterId);
        } else {
            alert("ID мастера не найден.");
        }

        function loadServices(masterId) {
            fetch(`https://requesthandler-dadreu.amvera.io/get_services_by_master.php?master_id=${masterId}`)
                .then(response => response.json())
                .then(data => {
                    const serviceGroup = document.getElementById('service-group');
                    serviceGroup.innerHTML = '';
                    if (data.success) {
                        data.services.forEach(service => {
                            const serviceItemDiv = document.createElement('div');
                            serviceItemDiv.classList.add('service-item');

                            servicesAvailability[service.id_service] = service.is_available;

                            serviceItemDiv.innerHTML = `
                                <span class="service-name">${service.name} (${service.price} ₽, ${service.duration} мин)</span>
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" ${service.is_available ? 'checked' : ''} onchange="toggleServiceAvailability(${service.id_service}, this)">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <button class="delete-button" onclick="deleteService(${service.id_service})">Удалить</button>
                            `;
                            serviceGroup.appendChild(serviceItemDiv);
                        });
                    } else {
                        serviceGroup.innerHTML = `<p>${data.message || "Услуги не найдены."}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                    document.getElementById('service-group').innerHTML = '<p>Ошибка подключения. Попробуйте снова.</p>';
                });
        }

        function toggleServiceAvailability(serviceId, checkbox) {
            servicesAvailability[serviceId] = checkbox.checked;
        }

        function deleteService(serviceId) {
            if (confirm('Вы уверены, что хотите удалить эту услугу?')) {
                fetch('https://requesthandler-dadreu.amvera.io/delete_service.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: serviceId, master_id: masterId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Услуга удалена');
                        loadServices(masterId);
                    } else {
                        alert('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка при удалении услуги:', error);
                    alert('Ошибка при удалении: ' + error);
                });
            }
        }

        function saveChanges() {
            const updatedServices = Object.keys(servicesAvailability).map(serviceId => ({
                master_id: masterId,
                service_id: serviceId,
                available: servicesAvailability[serviceId] ? 1 : 0
            }));

            fetch('https://requesthandler-dadreu.amvera.io/toggle_service_availability.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedServices)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ответ от toggle_service_availability.php:', data);
                if (data.success) {
                    alert("Настройки успешно сохранены.");
                    window.location.href = `masterReq.html?master_id=${masterId}`;
                } else {
                    alert("Ошибка при сохранении настроек: " + (data.message || "Неизвестная ошибка"));
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении изменений:', error);
                alert('Ошибка при сохранении изменений: ' + error.message);
            });
        }

        function goToAddService() {
            if (masterId) {
                window.location.href = `add-service.html?master_id=${masterId}`;
            } else {
                alert("ID мастера не указан.");
            }
        }
    </script>
</body>
</html>