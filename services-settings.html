<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка услуг</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Верхний белый хедер с кнопкой возврата -->
    <header class="top-bar">
        <button class="back-button" onclick="window.location.href='masterReq.html?master_id=' + masterId">Назад</button>
        <h1>Настройка услуг</h1>
        <div></div> <!-- Пространство для выравнивания -->
    </header>

    <!-- Основной контент с серым фоном -->
    <div class="content" style="background-color: #f1f1f1;">
        <!-- Подпись над блоком услуг -->
        <p class="select-services">Выберите услуги</p>

        <!-- Список услуг с тумблерами -->
        <div id="service-group" class="service-group">
            <!-- Сюда будут динамически добавляться услуги -->
        </div>

        <!-- Кнопки для сохранения и добавления услуги -->
        <div class="buttons-container">
            <button class="save-button" onclick="saveChanges()">Сохранить</button>
            <button class="add-service-button" onclick="goToAddService()">Добавить услугу</button>
        </div>
    </div>

    <script>
        // Получаем masterId из параметров URL
        const urlParams = new URLSearchParams(window.location.search);
        const masterId = urlParams.get('master_id');
        
        // Объект для хранения состояния доступности услуг
        let servicesAvailability = {};

        if (masterId) {
            loadServices(masterId);
        } else {
            alert("ID мастера не найден.");
        }

        // Функция для загрузки услуг
        function loadServices(masterId) {
            fetch(`https://gpjj.ru/get_services_by_master.php?master_id=${masterId}`)
                .then(response => response.json())
                .then(data => {
                    const serviceGroup = document.getElementById('service-group');
                    if (data.success) {
                        data.services.forEach(service => {
                            const serviceItemDiv = document.createElement('div');
                            serviceItemDiv.classList.add('service-item');

                            servicesAvailability[service.id_service] = service.is_available;

                            serviceItemDiv.innerHTML = `
                                <span class="service-name">${service.name}</span>
                                <label class="switch">
                                    <input type="checkbox" ${service.is_available ? 'checked' : ''} onchange="toggleServiceAvailability(${service.id_service}, this)">
                                    <span class="slider round"></span>
                                </label>
                            `;
                            serviceGroup.appendChild(serviceItemDiv);
                        });
                    } else {
                        serviceGroup.innerHTML = `<p>${data.message || "Услуги не найдены."}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                    document.getElementById('service-group').innerHTML = '<p>Ошибка подключения. Попробуйте снова.</p>';
                });
        }

        // Функция для изменения состояния доступности услуги
        function toggleServiceAvailability(serviceId, checkbox) {
            servicesAvailability[serviceId] = checkbox.checked;
        }

        // Функция для сохранения изменений
        function saveChanges() {
            const updatedServices = Object.keys(servicesAvailability).map(serviceId => ({
                master_id: masterId,
                service_id: serviceId,
                available: servicesAvailability[serviceId] ? 1 : 0
            }));

            fetch('https://gpjj.ru/toggle_service_availability.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedServices)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ответ от toggle_service_availability.php:', data);
                if (data.success) {
                    alert("Настройки успешно сохранены.");
                    window.location.href = `masterReq.html?master_id=${masterId}`;
                } else {
                    alert("Ошибка при сохранении настроек: " + (data.message || "Неизвестная ошибка"));
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении изменений:', error);
                alert('Ошибка при сохранении изменений: ' + error.message);
            });
        }

        // Функция для перехода на страницу добавления услуги
        function goToAddService() {
            if (masterId) {
                window.location.href = `add-service.html?master_id=${masterId}`;
            } else {
                alert("ID мастера не указан.");
            }
        }
    </script>
</body>
</html>