<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка услуг</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Верхний белый хедер с кнопкой возврата -->
    <header class="top-bar">
        <button class="back-button" onclick="window.location.href='masterReq.html?master_id=' + masterId">Назад</button>
        <h1>Настройка услуг</h1>
        <div></div> <!-- Пространство для выравнивания -->
    </header>

    <!-- Основной контент с серым фоном -->
    <div class="content" style="background-color: #f1f1f1;">
        <!-- Подпись над блоком услуг -->
        <p class="select-services">Список услуг</p>

        <!-- Список услуг с тумблерами и кнопкой удаления -->
        <div id="service-group" class="service-group">
            <!-- Сюда будут динамически добавляться услуги -->
        </div>

        <!-- Кнопки для сохранения и добавления услуги -->
        <div class="buttons-container">
            <button class="save-button" onclick="saveChanges()">Сохранить</button>
            <button class="add-service-button" onclick="goToAddService()">Добавить услугу</button>
        </div>
    </div>

    <script>
        // Получаем masterId из параметров URL
        const urlParams = new URLSearchParams(window.location.search);
        const masterId = urlParams.get('master_id');
        
        // Объект для хранения состояния доступности услуг
        let servicesAvailability = {};

        if (masterId) {
            loadServices();
        } else {
            alert("ID мастера не найден.");
        }

        // Функция для загрузки всех услуг
        function loadServices() {
            fetch('https://requesthandler-dadreu.amvera.io/get_services.php') // Используем общий список услуг
                .then(response => response.json())
                .then(data => {
                    const serviceGroup = document.getElementById('service-group');
                    serviceGroup.innerHTML = '';
                    if (Array.isArray(data)) {
                        data.forEach(service => {
                            const serviceItemDiv = document.createElement('div');
                            serviceItemDiv.classList.add('service-item');

                            servicesAvailability[service.id] = service.is_available === '1';

                            serviceItemDiv.innerHTML = `
                                <span class="service-name">${service.name} (${service.price} ₽, ${service.duration} мин)</span>
                                <label class="switch">
                                    <input type="checkbox" ${service.is_available === '1' ? 'checked' : ''} onchange="toggleServiceAvailability(${service.id}, this)">
                                    <span class="slider round"></span>
                                </label>
                                <button class="delete-btn" onclick="deleteService(${service.id})">Удалить</button>
                            `;
                            serviceGroup.appendChild(serviceItemDiv);
                        });
                    } else {
                        serviceGroup.innerHTML = `<p>Услуги не найдены.</p>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                    document.getElementById('service-group').innerHTML = '<p>Ошибка подключения. Попробуйте снова.</p>';
                });
        }

        // Функция для изменения состояния доступности услуги
        function toggleServiceAvailability(serviceId, checkbox) {
            servicesAvailability[serviceId] = checkbox.checked;
        }

        // Функция для удаления услуги
        function deleteService(serviceId) {
            if (confirm('Вы уверены, что хотите удалить эту услугу?')) {
                fetch('https://requesthandler-dadreu.amvera.io/delete_service.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: serviceId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Услуга удалена');
                        loadServices(); // Перезагружаем список
                    } else {
                        alert('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Ошибка при удалении: ' + error);
                });
            }
        }

        // Функция для сохранения изменений
        function saveChanges() {
            const updatedServices = Object.keys(servicesAvailability).map(serviceId => ({
                service_id: serviceId,
                available: servicesAvailability[serviceId] ? 1 : 0
            }));

            fetch('https://requesthandler-dadreu.amvera.io/toggle_service_availability.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedServices)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Настройки успешно сохранены.");
                } else {
                    alert("Ошибка при сохранении: " + (data.message || "Неизвестная ошибка"));
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении изменений:', error);
                alert('Ошибка при сохранении: ' + error.message);
            });
        }

        // Функция для перехода на страницу добавления услуги
        function goToAddService() {
            if (masterId) {
                window.location.href = `add-service.html?master_id=${masterId}`;
            } else {
                alert("ID мастера не указан.");
            }
        }
    </script>
</body>
</html>