<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Верхний блок с белым фоном -->
    <div class="top-bar">
        <button class="back-button">Назад</button>
        <h1>Запись</h1>
    </div>

    <!-- Основной контент на сером фоне -->
    <div class="content">
        <!-- Выбор мастера -->
        <div class="form-section">
            <h2>Выбранное время</h2>
            <p id="selected-date"></p>
            <p id="selected-time"></p>
        </div>
        
        <div class="form-section">
            <h2>Выберите мастера</h2>
            <select class="form-input" id="master-select">
                <!-- Мастера будут подгружены сюда -->
            </select>
        </div>

        <!-- Выбор услуги -->
        <div class="form-section">
            <h2>Выберите услугу</h2>
            <select class="form-input" id="service-select">
                <!-- Услуги будут подгружены сюда -->
            </select>
        </div>

        <!-- Ввод ФИО -->
        <div class="form-section">
            <h2>Ваше ФИО</h2>
            <input type="text" class="form-input" id="fio-input" placeholder="Введите ваше ФИО" pattern="^[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*)?)?$" required>
        </div>

        <!-- Ввод номера телефона -->
        <div class="form-section">
            <h2>Номер телефона</h2>
            <input type="tel" class="form-input" id="phone-input" placeholder="Введите номер телефона" pattern="^((\+7|7|8)[\s\-]?)?(\(?\d{3}\)?[\s\-]?)?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$" required>
        </div>

        <!-- Кнопка подтверждения -->
        <button class="confirm-button" id="confirm-button">Подтвердить запись</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const masterId = urlParams.get('master_id');
            const selectedDate = urlParams.get('date');
            const selectedTime = urlParams.get('time');
            const previousPage = urlParams.get('previousPage') || '/masterReq.html';

            const fioInput = document.getElementById('fio-input');
            const phoneInput = document.getElementById('phone-input');
            const confirmButton = document.getElementById('confirm-button');
            const masterSelect = document.getElementById('master-select');
            const serviceSelect = document.getElementById('service-select');

            if (masterId) {
                console.log(`ID мастера: ${masterId}`);
            }
            if (selectedDate && selectedTime) {
                console.log(`Выбранная дата: ${selectedDate}, Время: ${selectedTime}`);

                // Выводим дату и время на страницу
                document.getElementById('selected-date').textContent = `Дата: ${selectedDate}`;
                document.getElementById('selected-time').textContent = `Время: ${selectedTime}`;
            }

            // Получение данных о мастерах и услугах
            fetch('get_data.php')
                .then(response => response.json())
                .then(data => {
                    console.log(data);  // Выводим данные в консоль для проверки

                    // Заполняем список мастеров
                    data.masters.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.id;
                        option.textContent = master.full_name;  // Используем full_name для мастеров
                        masterSelect.appendChild(option);
                    });

                    // Заполняем список услуг
                    data.services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        serviceSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Ошибка при загрузке данных:', error));

            // Валидация данных формы
            function validateForm() {
                let isValid = true;

                const fioPattern = /^[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*)?)?$/;
                if (!fioInput.value.match(fioPattern)) {
                    alert("ФИО должно содержать только буквы, пробелы и дефисы, начинаться с заглавной буквы.");
                    isValid = false; // Останавливаем выполнение
                }

                const phonePattern = /^((\+7|7|8)[\s\-]?)?(\(?\d{3}\)?[\s\-]?)?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$/;
                if (!phoneInput.value.match(phonePattern)) {
                    alert("Номер телефона должен быть в формате: +79999999999 или 89999999999.");
                    isValid = false; // Останавливаем выполнение
                }

                return isValid;
            }

            // Обработчик кнопки "Назад"
            document.querySelector('.back-button').addEventListener('click', function () {
                const returnUrl = new URL(previousPage, window.location.origin);
                // Добавляем параметры, если они существуют
                if (masterId) returnUrl.searchParams.set('master_id', masterId);
                if (selectedDate) returnUrl.searchParams.set('date', selectedDate);
                if (selectedTime) returnUrl.searchParams.set('time', selectedTime);
                window.location.href = returnUrl.toString(); // Переход на правильную страницу с параметрами
            });

            // Привязка события к кнопке "Подтвердить"
            confirmButton.addEventListener('click', function() {
                if (!validateForm()) {
                    // Если валидация не прошла, не продолжаем
                    return;
                }

                // Получаем данные из формы
                const masterId = masterSelect.value;
                const serviceId = serviceSelect.value;
                const fio = fioInput.value;
                const phone = phoneInput.value;
                const date = selectedDate;
                const time = selectedTime;

                // Отправляем данные на сервер через fetch
                fetch('create_appointment.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    master_id: masterId,
                    service_id: serviceId,
                    fio: fio,
                    phone: phone,
                    date: date,
                    time: time
                })
            })
            .then(response => response.text())  // Вместо response.json()
            .then(data => {
                console.log(data); // Выведет текстовый ответ сервера
                try {
                    const jsonData = JSON.parse(data); // Пробуем преобразовать в JSON
                    if (jsonData.success) {
                        alert('Запись успешно создана!');
<<<<<<< HEAD
                        const creatorMasterId = urlParams.get('master_id'); // ID того, кто создаёт запись
                        window.location.href = `masterReq.html?master_id=${creatorMasterId}`;

=======
                        window.location.href = `masterReq.html?master_id=${masterId}`;
>>>>>>> 6fbd783688195d715b38fde99f4d03d08cbf29a8
                    } else {
                        alert('Ошибка при создании записи: ' + jsonData.message);
                    }
                } catch (e) {
                    console.error('Ошибка при парсинге JSON:', e);
                    alert('Ошибка в формате данных от сервера.');
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке данных:', error);
                alert('Произошла ошибка при создании записи.');
            });

            });
        });
    </script>
</body>
</html>
