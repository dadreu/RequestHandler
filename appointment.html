<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="top-bar">
        <button class="back-button">Назад</button>
        <h1>Запись</h1>
    </div>

    <div class="content">
        <div class="form-section">
            <h2>Выберите мастера</h2>
            <select class="form  <option disabled selected>Загрузка...</option>
            </select>
        </div>

        <div class="form-section">
            <h2>Выберите услугу</h2>
            <select class="form-input" id="service-select">
                <option disabled selected>Выберите мастера</option>
            </select>
        </div>

        <div class="form-section">
            <h2>Ваше ФИО</h2>
            <input type="text" class="form-input" id="fio-input" placeholder="Введите ваше ФИО" pattern="^[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*)?)?$" required>
        </div>

        <div class="form-section" id="phone-section" style="display: none;">
            <h2>Номер телефона</h2>
            <input type="tel" class="form-input" id="phone-input" placeholder="Введите номер телефона" pattern="^((\+7|7|8)[\s\-]?)?(\(?\d{3}\)?[\s\-]?)?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$" required>
        </div>

        <button class="confirm-button" id="confirm-button">Подтвердить запись</button>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const masterId = urlParams.get('master_id');
    const clientId = urlParams.get('client_id');
    const selectedMasterId = urlParams.get('selected_master_id') || masterId;
    const serviceId = urlParams.get('service_id');
    const fio = urlParams.get('fio');
    const phone = urlParams.get('phone');

    const role = masterId ? 'master' : (clientId ? 'client' : null);
    if (!role) {
        alert('Ошибка: не удалось определить роль пользователя. Пожалуйста, вернитесь и попробуйте снова.');
        window.history.back();
        return;
    }

    const fioInput = document.getElementById('fio-input');
    const phoneInput = document.getElementById('phone-input');
    const confirmButton = document.getElementById('confirm-button');
    const masterSelect = document.getElementById('master-select');
    const serviceSelect = document.getElementById('service-select');
    const backButton = document.querySelector('.back-button');
    const phoneSection = document.getElementById('phone-section');

    const goBack = () => {
        if (role === 'master' && masterId) {
            window.location.href = `masterReq.html?master_id=${masterId}`;
        } else if (role === 'client' && clientId) {
            window.location.href = `clientReq.html?client_id=${clientId}`;
        } else {
            window.history.back();
        }
    };
    backButton.addEventListener('click', goBack);

    const loadMasters = (defaultMasterId = '') => {
        fetch('get_masters.php')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Ошибка сервера:', data.error);
                    alert(`Ошибка сервера: ${data.error}`);
                    masterSelect.innerHTML = '<option disabled selected>Ошибка загрузки</option>';
                    return;
                }
                masterSelect.innerHTML = '';
                if (data.masters && data.masters.length > 0) {
                    data.masters.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.id;
                        option.textContent = master.full_name;
                        masterSelect.appendChild(option);
                    });
                    if (defaultMasterId) {
                        masterSelect.value = defaultMasterId;
                        loadServices(masterSelect.value);
                    }
                } else {
                    masterSelect.innerHTML = '<option disabled selected>Нет мастеров</option>';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке мастеров:', error);
                alert('Не удалось загрузить список мастеров.');
                masterSelect.innerHTML = '<option disabled selected>Ошибка загрузки</option>';
            });
    };

    const loadServices = (masterId) => {
        if (!masterId) {
            serviceSelect.innerHTML = '<option disabled selected>Выберите мастера</option>';
            return;
        }
        fetch(`get_services.php?master_id=${masterId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Ошибка сервера:', data.error);
                    alert(`Ошибка сервера: ${data.error}`);
                    serviceSelect.innerHTML = '<option disabled selected>Ошибка загрузки</option>';
                    return;
                }
                serviceSelect.innerHTML = '';
                if (data.services && data.services.length > 0) {
                    data.services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        serviceSelect.appendChild(option);
                    });
                    if (serviceId) {
                        serviceSelect.value = serviceId;
                    }
                } else {
                    serviceSelect.innerHTML = '<option disabled selected>Нет услуг</option>';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке услуг:', error);
                alert('Не удалось загрузить список услуг.');
                serviceSelect.innerHTML = '<option disabled selected>Ошибка загрузки</option>';
            });
    };

    loadMasters(selectedMasterId);
    if (fio) fioInput.value = decodeURIComponent(fio);
    if (phone && role === 'master') phoneInput.value = phone;

    if (role === 'master') {
        phoneSection.style.display = 'block';
    } else {
        phoneSection.style.display = 'none';
    }

    let clientPhone = '';
    if (role === 'client') {
        fetch(`get_client_phone.php?client_id=${clientId}`)
            .then(response => response.json())
            .then(data => {
                if (data.phone) {
                    clientPhone = data.phone;
                } else {
                    alert('Ошибка: не удалось получить номер телефона клиента.');
                    window.history.back();
                }
            })
            .catch(error => {
                console.error('Ошибка при получении номера телефона:', error);
                alert('Произошла ошибка при получении данных. Пожалуйста, попробуйте снова.');
                window.history.back();
            });
    }

    masterSelect.addEventListener('change', () => loadServices(masterSelect.value));

    const validateForm = () => {
        const fioPattern = /^[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*(?:\s+[А-ЯЁ][а-яё]+(?:[-][А-ЯЁ][а-яё]+)*)?)?$/;
        if (!fioInput.value.match(fioPattern)) {
            alert('ФИО должно начинаться с заглавной буквы и содержать только буквы, пробелы или дефисы.');
            return false;
        }
        if (role === 'master') {
            const phonePattern = /^((\+7|7|8)[\s\-]?)?(\(?\d{3}\)?[\s\-]?)?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$/;
            if (!phoneInput.value.match(phonePattern)) {
                alert('Номер телефона должен быть в формате: +79999999999 или 89999999999.');
                return false;
            }
        }
        return true;
    };

    confirmButton.addEventListener('click', () => {
        if (role === 'master' && !validateForm()) return;

        const selectedMasterId = masterSelect.value;
        const serviceId = serviceSelect.value;
        const fio = fioInput.value;
        const phone = role === 'client' ? clientPhone : phoneInput.value;
        const originalMasterId = masterId || null;

        if (!selectedMasterId || !serviceId) {
            alert('Пожалуйста, выберите мастера и услугу.');
            return;
        }

        const redirectUrl = `date-selection.html?selected_master_id=${selectedMasterId}&service_id=${serviceId}&fio=${encodeURIComponent(fio)}&phone=${encodeURIComponent(phone)}&original_master_id=${originalMasterId}&client_id=${clientId || null}&role=${role}`;
        window.location.href = redirectUrl;
    });
});
    </script>
</body>
</html>