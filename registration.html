<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="content">
        <h2>Регистрация</h2>
        <form id="registrationForm">
            <div class="form-input-group">
                <label for="phone">Номер телефона</label>
                <input type="tel" id="phone" name="phone" placeholder="Введите номер телефона" required>
            </div>
            <div class="form-input-group" id="full-name-group" style="display: none;">
                <label for="full_name">ФИО</label>
                <input type="text" id="full_name" name="full_name" placeholder="Введите ФИО">
            </div>
            <div class="form-input-group" id="code-group" style="display: none;">
                <label for="code">Код подтверждения</label>
                <input type="text" id="code" name="code" placeholder="Введите код">
            </div>
            <div class="form-input-group" id="password-group" style="display: none;">
                <label for="password">Пароль</label>
                <input type="password" id="password" name="password" placeholder="Введите пароль">
                <button type="button" id="save-password">Сохранить</button>
            </div>
            <div class="form-input-group">
                <button type="submit" id="submit-button">Зарегистрироваться</button>
            </div>
            <div class="error-message" id="notification" style="display: none;"></div>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('registrationForm');
            const phoneInput = document.getElementById('phone');
            const fullNameGroup = document.getElementById('full-name-group');
            const fullNameInput = document.getElementById('full_name');
            const codeGroup = document.getElementById('code-group');
            const passwordGroup = document.getElementById('password-group');
            const submitButton = document.getElementById('submit-button');
            const notification = document.getElementById('notification');

            let clientId = null;
            let verificationCode = null;

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const phone = phoneInput.value.trim();

                fetch('check_phone.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ phone })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.role === 'master') {
                        notification.style.display = 'block';
                        notification.textContent = 'Мастера не могут регистрироваться.';
                    } else if (data.role === 'client') {
                        clientId = data.client_id;
                        fetch('send_verification_code.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({ client_id: clientId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                verificationCode = data.code;
                                codeGroup.style.display = 'block';
                                submitButton.textContent = 'Подтвердить код';
                                form.removeEventListener('submit', arguments.callee);
                                form.addEventListener('submit', confirmCode);
                            } else {
                                notification.style.display = 'block';
                                notification.textContent = 'Ошибка отправки кода.';
                            }
                        });
                    } else if (data.role === 'new_client') {
                        notification.style.display = 'block';
                        notification.textContent = 'Номер не найден. Зарегистрируйтесь как новый клиент.';
                        fullNameGroup.style.display = 'block';
                        fullNameInput.setAttribute('required', 'required');
                        submitButton.textContent = 'Отправить код';
                        form.removeEventListener('submit', arguments.callee);
                        form.addEventListener('submit', registerNewClient);
                    } else {
                        notification.style.display = 'block';
                        notification.textContent = 'Ошибка проверки номера.';
                    }
                });
            });

            function registerNewClient(event) {
                event.preventDefault();
                const phone = phoneInput.value.trim();
                const fullName = fullNameInput.value.trim();

                if (!fullName) {
                    notification.style.display = 'block';
                    notification.textContent = 'Введите ФИО.';
                    return;
                }

                fetch('register_new_client.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ phone, full_name: fullName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        clientId = data.client_id;
                        verificationCode = data.code;
                        codeGroup.style.display = 'block';
                        fullNameGroup.style.display = 'none';
                        fullNameInput.removeAttribute('required');
                        submitButton.textContent = 'Подтвердить код';
                        form.removeEventListener('submit', arguments.callee);
                        form.addEventListener('submit', confirmCode);
                    } else {
                        notification.style.display = 'block';
                        notification.textContent = 'Ошибка регистрации.';
                    }
                });
            }

            function confirmCode(event) {
                event.preventDefault();
                const code = document.getElementById('code').value.trim();
                if (code === verificationCode) {
                    passwordGroup.style.display = 'block';
                    codeGroup.style.display = 'none';
                    submitButton.style.display = 'none';
                    notification.style.display = 'block';
                    notification.textContent = 'Код подтверждён. Введите пароль.';
                } else {
                    notification.style.display = 'block';
                    notification.textContent = 'Неверный код подтверждения.';
                }
            }

            document.getElementById('save-password').addEventListener('click', function() {
                const password = document.getElementById('password').value.trim();
                if (!password) {
                    notification.style.display = 'block';
                    notification.textContent = 'Введите пароль.';
                    return;
                }

                fetch('set_password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ client_id: clientId, password })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Пароль успешно сохранён!');
                        window.location.href = 'index.html';
                    } else {
                        notification.style.display = 'block';
                        notification.textContent = data.message || 'Ошибка сохранения пароля.';
                    }
                });
            });
        });
    </script>
</body>
</html>